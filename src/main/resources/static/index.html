<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Clone - Advanced</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; display: flex; height: 100vh; }
        #sidebar { width: 320px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; padding: 10px; }
        #main { flex: 1; display: flex; flex-direction: column; padding: 10px; }
        .section { margin-bottom: 10px; }
        input, button, textarea, select { padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; width: 100%; }
        button { background: #0088cc; color: white; border: none; cursor: pointer; }
        button:hover { background: #006699; }
        .chat-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; background: #e3f2fd; }
        .chat-item.active { background: #b3e5fc; }
        #messages-list { flex: 1; overflow-y: auto; padding: 5px; border: 1px solid #ccc; border-radius: 5px; background: #fff; }
        .message { margin-bottom: 8px; padding: 5px 10px; border-radius: 5px; background: #f1f1f1; }
        .message.self { background: #d1ffd1; align-self: flex-end; }
        #send-area { display: flex; margin-top: 5px; }
        #send-area textarea { flex: 1; }
        #send-area button { margin-left: 5px; width: 100px; }
        .participants-input { display: flex; gap: 5px; }
        .participants-input input { flex: 1; }
    </style>
</head>
<body>
<div id="sidebar">
    <div class="section">
        <h3>Auth / Register</h3>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <input type="text" id="phone" placeholder="Phone Number (+123456789)">
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
        <div id="auth-status"></div>
    </div>
    <div class="section">
        <h3>Chats</h3>
        <div id="chats-list"></div>
        <input type="text" id="chat-name" placeholder="New Chat Name">
        <select id="chat-type" onchange="toggleParticipantsField()">
            <option value="GROUP">GROUP</option>
            <option value="PRIVATE">PRIVATE</option>
        </select>
        <div class="participants-input">
            <input type="text" id="chat-participants" placeholder="Participants (comma-separated)">
        </div>
        <button onclick="createChat()">Create Chat</button>
        <button onclick="refreshChats()">Refresh Chats</button>
    </div>
</div>
<div id="main">
    <div class="section">
        <h3>Messages</h3>
        <div id="messages-list"></div>
    </div>
    <div id="send-area">
        <textarea id="message-text" placeholder="Type message"></textarea>
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    let token = '';
    let activeChatId = null;
    const API_URL = 'http://localhost:8080/api/v1';

    // Общая функция fetch
    async function apiRequest(url, method='GET', body=null) {
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(`${API_URL}${url}`, options);
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Ошибка запроса');
        return data;
    }

    // Регистрация
    async function register() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const phone = document.getElementById('phone').value;
        if (!phone) return alert('Номер телефона обязателен');

        try {
            const data = await apiRequest('/auth/signup', 'POST', {
                username, password, phoneNumber: phone, firstName: 'Test', lastName: 'User'
            });
            token = data.token;
            document.getElementById('auth-status').innerHTML = `<p style="color: green;">Зарегистрирован и залогинен как ${data.user.username}</p>`;
            refreshChats();
        } catch (error) {
            document.getElementById('auth-status').innerHTML = `<p style="color: red;">Ошибка: ${error.message}</p>`;
        }
    }

    // Логин
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        try {
            const data = await apiRequest('/auth/signin', 'POST', { username, password });
            token = data.token;
            document.getElementById('auth-status').innerHTML = `<p style="color: green;">Залогинен как ${data.user.username}</p>`;
            refreshChats();
        } catch (error) {
            document.getElementById('auth-status').innerHTML = `<p style="color: red;">Ошибка: ${error.message}</p>`;
        }
    }

    // Создание чата
    async function createChat() {
        const name = document.getElementById('chat-name').value || 'New Chat';
        const type = document.getElementById('chat-type').value;
        let participantsInput = document.getElementById('chat-participants').value.trim();
        let participantIds = [];

        if (type === 'PRIVATE') {
            if (!participantsInput) return alert('Укажите одного пользователя для приватного чата');
            const usernames = participantsInput.split(',').map(u => u.trim());
            if (usernames.length > 1) return alert('Приватный чат может иметь только одного собеседника');
            participantIds = usernames; // Предполагаем, что бэкенд принимает usernames для PRIVATE
        } else {
            // GROUP чат
            if (participantsInput) participantIds = participantsInput.split(',').map(u => u.trim());
        }

        try {
            await apiRequest('/chats', 'POST', { name, type, participantIds });
            document.getElementById('chat-name').value = '';
            document.getElementById('chat-participants').value = '';
            refreshChats();
        } catch (error) {
            alert(`Ошибка: ${error.message}`);
        }
    }

    // Получение чатов
    async function refreshChats() {
        if (!token) return;
        try {
            const chats = await apiRequest('/chats');
            const list = document.getElementById('chats-list');
            list.innerHTML = '';
            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'chat-item' + (chat.id == activeChatId ? ' active' : '');
                div.innerText = `${chat.name} (${chat.type})`;
                div.onclick = () => selectChat(chat.id);
                list.appendChild(div);
            });
        } catch (error) {
            console.error(error);
        }
    }

    // Выбор чата
    function selectChat(chatId) {
        activeChatId = chatId;
        refreshChats();
        getMessages();
    }

    // Получение сообщений
    async function getMessages() {
        if (!token || !activeChatId) return;
        try {
            const messages = await apiRequest(`/chats/${activeChatId}/messages`);
            const list = document.getElementById('messages-list');
            list.innerHTML = '';
            messages.content.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'message' + (msg.sender.username === document.getElementById('username').value ? ' self' : '');
                div.innerHTML = `<strong>${msg.sender.username}:</strong> ${msg.content}<br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        } catch (error) {
            console.error(error);
        }
    }

    // Отправка сообщения
    async function sendMessage() {
        if (!token || !activeChatId) return alert('Сначала выберите чат');
        const text = document.getElementById('message-text').value;
        if (!text) return;
        try {
            await apiRequest(`/chats/${activeChatId}/messages`, 'POST', { content: text, type: 'TEXT' });
            document.getElementById('message-text').value = '';
            getMessages();
        } catch (error) {
            console.error(error);
        }
    }

    // Авто-обновление сообщений каждые 3 секунды
    setInterval(() => { if(activeChatId) getMessages(); }, 3000);

    // Включение/отключение поля участников при выборе типа
    function toggleParticipantsField() {
        const type = document.getElementById('chat-type').value;
        const participants = document.getElementById('chat-participants');
        if(type === 'PRIVATE') participants.placeholder = 'Single username';
        else participants.placeholder = 'Comma-separated usernames';
    }
</script>
</body>
</html>